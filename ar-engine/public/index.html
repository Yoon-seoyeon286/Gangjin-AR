<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°•ì§„ AR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            width: 100%;
            height: 100%;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            background: #000;
        }

        /* ë¡œë”© í™”ë©´ */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        #loading-screen.hidden {
            display: none;
        }

        #loading-text {
            color: #4da6ff;
            font-size: 24px;
            margin-bottom: 20px;
        }

        #loading-progress {
            width: 300px;
            height: 30px;
            background: #222;
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid #4da6ff;
        }

        #loading-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #4da6ff, #80c0ff);
            transition: width 0.3s;
        }

        #loading-status {
            color: #888;
            font-size: 14px;
            margin-top: 10px;
        }

        /* Layer 1: Background - ì¹´ë©”ë¼ ë¹„ë””ì˜¤ */
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            overflow: hidden;
        }

        #video-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
            pointer-events: none;
        }

        #video-background.mirror {
            transform: scaleX(-1);
        }

        /* Layer 2: Virtual - Three.js Canvas (íˆ¬ëª…) */
        /* width/heightëŠ” Three.jsê°€ ì¸ë¼ì¸ìœ¼ë¡œ ì„¤ì •í•˜ë¯€ë¡œ ì§€ì •í•˜ì§€ ì•ŠìŒ */
        #canvas-container canvas {
            z-index: 1;
            pointer-events: none;
        }

        /* í„°ì¹˜ ì˜ì—­ (ì „ì²´ í™”ë©´) */
        #touch-area {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 2;
            background: transparent;
        }

        /* ì•ˆë‚´ ì˜¤ë²„ë ˆì´ (í™”ë©´ ì¤‘ì•™) */
        #instruction-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px 30px;
            border-radius: 12px;
            font-size: 16px;
            text-align: center;
            z-index: 100;
            pointer-events: none;
            transition: opacity 0.5s ease;
            line-height: 1.6;
            opacity: 0;
        }

        #instruction-overlay.visible {
            opacity: 1;
        }

        /* ìº¡ì²˜ ë²„íŠ¼ - í•˜ë‹¨ ì¤‘ì•™ í°ìƒ‰ ì› */
        #capture-btn {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 60px;
            background: #fff;
            border: 3px solid rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            cursor: pointer;
            z-index: 100;
        }

        #capture-btn:active {
            transform: translateX(-50%) scale(0.9);
        }

        /* ë‹¤ìš´ë¡œë“œ(ì €ì¥) ë²„íŠ¼ - ìº¡ì²˜ ì™¼ìª½ */
        #download-btn {
            position: absolute;
            bottom: 38px;
            left: calc(50% - 90px);
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            cursor: pointer;
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            line-height: 40px;
            text-align: center;
        }

        #download-btn.visible {
            display: flex;
        }

        #download-btn:active {
            transform: scale(0.9);
        }

        /* ë…¹í™” ë²„íŠ¼ - ìº¡ì²˜ ì˜¤ë¥¸ìª½, ì‘ì€ ë¹¨ê°„ ì› */
        #record-btn {
            position: absolute;
            bottom: 38px;
            left: calc(50% + 50px);
            width: 40px;
            height: 40px;
            background: #e03030;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            cursor: pointer;
            z-index: 100;
        }

        #record-btn.recording {
            background: #ff0000;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.15);
            }
        }

        #camera-switch {
            position: absolute;
            bottom: 38px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(20, 20, 20, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            color: #fff;
        }

        #camera-switch svg {
            width: 24px;
            height: 24px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: transform 0.5s ease;
        }

        #camera-switch:hover {
            background: rgba(77, 166, 255, 0.15);
            border-color: rgba(77, 166, 255, 0.5);
            color: #4da6ff;
            transform: scale(1.1) rotate(180deg);
            box-shadow: 0 0 20px rgba(77, 166, 255, 0.3);
        }

        #camera-switch:active {
            transform: scale(0.95) rotate(180deg);
        }

        /* ì˜ìƒ ì„ íƒ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
        #video-selector {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .video-btn {
            width: 36px;
            height: 36px;
            padding: 0;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            color: #fff;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .video-btn:active {
            transform: scale(0.9);
        }

        .video-btn.active {
            background: #4da6ff;
            border-color: #4da6ff;
            color: #000;
            font-weight: bold;
        }


        /* ì‹œì‘ í™”ë©´ ì˜¤ë²„ë ˆì´ */
        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10002;
            transition: opacity 0.5s ease;
        }

        #start-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #start-screen h1 {
            color: #4da6ff;
            font-size: 36px;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(77, 166, 255, 0.5);
        }

        #start-screen p {
            color: #888;
            font-size: 16px;
            margin-bottom: 40px;
            text-align: center;
            padding: 0 20px;
        }

        /* ì‹œì‘í•˜ê¸° ë²„íŠ¼ */
        #start-btn {
            padding: 20px 60px;
            background: linear-gradient(135deg, #4da6ff, #80c0ff);
            border: none;
            border-radius: 50px;
            color: #000;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 30px rgba(77, 166, 255, 0.5);
            transition: all 0.3s ease;
        }

        #start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 40px rgba(77, 166, 255, 0.7);
        }

        #start-btn:active {
            transform: scale(0.95);
        }

        #start-btn:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
            box-shadow: none;
        }

        #permission-status {
            margin-top: 30px;
            color: #666;
            font-size: 14px;
            text-align: center;
        }

        #permission-status .granted {
            color: #4da6ff;
        }

        #permission-status .denied {
            color: #ff4444;
        }

        #device-info {
            position: absolute;
            bottom: 20px;
            color: #444;
            font-size: 12px;
        }

        /* iOS ê¶Œí•œ ìš”ì²­ ë²„íŠ¼ (ë ˆê±°ì‹œ - ì´ì œ start-btn ì‚¬ìš©) */
        #ios-permission-btn {
            display: none;
        }

        /* ëª¨ë°”ì¼ ë””ë²„ê·¸ íŒ¨ë„ */
        #debug-panel {
            position: fixed;
            top: 60px;
            left: 10px;
            right: 10px;
            max-height: 200px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #4da6ff;
            border-radius: 8px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #4da6ff;
            overflow-y: auto;
            z-index: 9999;
            display: none;
            line-height: 1.4;
        }

        #debug-panel.visible {
            display: block;
        }

        #debug-panel .log-entry {
            margin-bottom: 4px;
            word-wrap: break-word;
        }

        #debug-panel .log-error {
            color: #ff4444;
        }

        #debug-panel .log-warn {
            color: #ffaa00;
        }

        #debug-panel .log-info {
            color: #00aaff;
        }

        /* ë””ë²„ê·¸ í† ê¸€ ë²„íŠ¼ */
        #debug-toggle {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #4da6ff;
            border-radius: 50%;
            color: #4da6ff;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #debug-toggle:active {
            transform: scale(0.9);
        }
    </style>
</head>

<body>
    <!-- ì‹œì‘ í™”ë©´ (ê¶Œí•œ ìš”ì²­ìš© - ì‚¬ìš©ì ì œìŠ¤ì²˜ í•„ìš”) -->
    <div id="start-screen">
        <h1>ê°•ì§„ AR</h1>
        <p>Web AR í‰ë©´ ì¸ì‹ ì—”ì§„<br>ì¹´ë©”ë¼ì™€ ì„¼ì„œ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤</p>
        <button id="start-btn">ì‹œì‘í•˜ê¸°</button>
        <div id="permission-status"></div>
        <div id="device-info"></div>
    </div>

    <!-- ë¡œë”© í™”ë©´ -->
    <div id="loading-screen" class="hidden">
        <div id="loading-text">ê°•ì§„ AR ë¡œë”© ì¤‘...</div>
        <div id="loading-progress">
            <div id="loading-bar"></div>
        </div>
        <div id="loading-status">AR ì—”ì§„ ì´ˆê¸°í™” ì¤‘...</div>
    </div>

    <!-- Layer 1: Background (ì¹´ë©”ë¼ ë¹„ë””ì˜¤) -->
    <!-- Layer 2: Virtual (Three.js ìº”ë²„ìŠ¤ - main.jsì—ì„œ ì¶”ê°€) -->
    <div id="canvas-container">
        <video id="video-background" playsinline autoplay muted></video>
    </div>

    <!-- Layer 3: Touch Area (í„°ì¹˜ ì´ë²¤íŠ¸ ìˆ˜ì‹ ) -->
    <div id="touch-area"></div>

    <!-- ì•ˆë‚´ ì˜¤ë²„ë ˆì´ (í„°ì¹˜ ì‹œ ì‚¬ë¼ì§) -->
    <div id="instruction-overlay">
        ë“œë˜ê·¸: ìœ„ì¹˜ ì´ë™<br>
        í•€ì¹˜: í¬ê¸° ì¡°ì ˆ
    </div>

    <!-- ì˜ìƒ ì„ íƒ ë²„íŠ¼ -->
    <div id="video-selector">
        <button class="video-btn active" data-video="greetgang.mp4">01</button>
        <button class="video-btn" data-video="singgang2.mp4">02</button>
    </div>

    <button id="download-btn">â†“</button>
    <button id="capture-btn"></button>
    <button id="record-btn"></button>
    <button id="camera-switch">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M20 11a8.1 8.1 0 0 0 -6.986 -6.918a8.095 8.095 0 0 0 -8.019 3.918h-2" />
            <path d="M4 13a8.1 8.1 0 0 0 15 3" />
            <path d="M19 16m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" />
            <path d="M5 8m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" />
            <path d="M15 2.5l3 3l-3 3" />
            <path d="M9 21.5l-3 -3l3 -3" />
        </svg>
    </button>

    <!-- iOS ê¶Œí•œ ìš”ì²­ ë²„íŠ¼ (ë ˆê±°ì‹œ) -->
    <button id="ios-permission-btn" style="display:none;"></button>

    <!-- ëª¨ë°”ì¼ ë””ë²„ê·¸ íŒ¨ë„ -->
    <button id="debug-toggle">ğŸ›</button>
    <div id="debug-panel"></div>

    <script>
        // ========================================
        // ëª¨ë°”ì¼ ë””ë²„ê·¸ íŒ¨ë„ ì´ˆê¸°í™”
        // ========================================
        (function () {
            const debugPanel = document.getElementById('debug-panel');
            const debugToggle = document.getElementById('debug-toggle');
            let isDebugVisible = false;
            const maxLogs = 50; // ìµœëŒ€ ë¡œê·¸ ê°œìˆ˜

            // ë””ë²„ê·¸ í† ê¸€ ë²„íŠ¼
            if (debugToggle) {
                debugToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    isDebugVisible = !isDebugVisible;
                    if (isDebugVisible) {
                        debugPanel.classList.add('visible');
                    } else {
                        debugPanel.classList.remove('visible');
                    }
                });
            }

            // ë¡œê·¸ ì¶”ê°€ í•¨ìˆ˜
            function addLog(message, type = 'log') {
                if (!debugPanel) return;

                const entry = document.createElement('div');
                entry.className = 'log-entry';
                if (type === 'error') entry.classList.add('log-error');
                else if (type === 'warn') entry.classList.add('log-warn');
                else if (type === 'info') entry.classList.add('log-info');

                const timestamp = new Date().toLocaleTimeString('ko-KR', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                entry.textContent = `[${timestamp}] ${message}`;

                debugPanel.appendChild(entry);

                // ìµœëŒ€ ë¡œê·¸ ê°œìˆ˜ ì œí•œ
                while (debugPanel.children.length > maxLogs) {
                    debugPanel.removeChild(debugPanel.firstChild);
                }

                // ìë™ ìŠ¤í¬ë¡¤
                debugPanel.scrollTop = debugPanel.scrollHeight;
            }

            // console.log ê°€ë¡œì±„ê¸°
            const originalLog = console.log;
            const originalError = console.error;
            const originalWarn = console.warn;
            const originalInfo = console.info;

            console.log = function (...args) {
                originalLog.apply(console, args);
                addLog(args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' '), 'log');
            };

            console.error = function (...args) {
                originalError.apply(console, args);
                addLog(args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' '), 'error');
            };

            console.warn = function (...args) {
                originalWarn.apply(console, args);
                addLog(args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' '), 'warn');
            };

            console.info = function (...args) {
                originalInfo.apply(console, args);
                addLog(args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' '), 'info');
            };

            // ì—ëŸ¬ ì´ë²¤íŠ¸ ìºì¹˜
            window.addEventListener('error', (e) => {
                addLog(`ERROR: ${e.message} at ${e.filename}:${e.lineno}`, 'error');
            });

            console.log('[Debug] ëª¨ë°”ì¼ ë””ë²„ê·¸ íŒ¨ë„ ì´ˆê¸°í™” ì™„ë£Œ');
        })();

        console.log('í˜ì´ì§€ ë¡œë“œ ì‹œì‘');

        // ========================================
        // ë””ë°”ì´ìŠ¤ ì •ë³´ ê°ì§€
        // ========================================
        function detectDevice() {
            const ua = navigator.userAgent;
            const isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
            const isAndroid = /Android/.test(ua);
            const isSafari = /Safari/.test(ua) && !/Chrome/.test(ua);

            let iosVersion = 0;
            if (isIOS) {
                const match = ua.match(/OS (\d+)_/);
                if (match) iosVersion = parseInt(match[1], 10);
            }

            const needsPermission = isIOS && iosVersion >= 13 &&
                typeof DeviceOrientationEvent !== 'undefined' &&
                typeof DeviceOrientationEvent.requestPermission === 'function';

            return { isIOS, isAndroid, isSafari, iosVersion, needsPermission };
        }

        const deviceInfo = detectDevice();

        // ë””ë°”ì´ìŠ¤ ì •ë³´ í‘œì‹œ
        const deviceInfoEl = document.getElementById('device-info');
        if (deviceInfoEl) {
            let info = '';
            if (deviceInfo.isIOS) info = `iOS ${deviceInfo.iosVersion}`;
            else if (deviceInfo.isAndroid) info = 'Android';
            else info = 'Desktop';
            if (deviceInfo.needsPermission) info += ' (ê¶Œí•œ ìš”ì²­ í•„ìš”)';
            deviceInfoEl.textContent = info;
        }

        // ========================================
        // ë¡œë”© í”„ë¡œê·¸ë ˆìŠ¤ í•¨ìˆ˜
        // ========================================
        function updateLoadingProgress(percent, status) {
            const bar = document.getElementById('loading-bar');
            const statusText = document.getElementById('loading-status');

            if (bar) bar.style.width = percent + '%';
            if (statusText) statusText.textContent = status;
        }

        function showLoadingScreen() {
            const screen = document.getElementById('loading-screen');
            if (screen) screen.classList.remove('hidden');
        }

        function hideLoadingScreen() {
            const screen = document.getElementById('loading-screen');
            if (screen) screen.classList.add('hidden');
        }

        function hideStartScreen() {
            const screen = document.getElementById('start-screen');
            if (screen) screen.classList.add('hidden');
        }

        // ì „ì—­ì— ë…¸ì¶œ
        window.updateLoadingProgress = updateLoadingProgress;
        window.showLoadingScreen = showLoadingScreen;
        window.hideLoadingScreen = hideLoadingScreen;
        window.hideStartScreen = hideStartScreen;
        window.deviceInfo = deviceInfo;

        // ========================================
        // ì‹œì‘ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬ (ì‚¬ìš©ì ì œìŠ¤ì²˜)
        // ========================================
        const startBtn = document.getElementById('start-btn');
        const permissionStatus = document.getElementById('permission-status');

        startBtn.addEventListener('click', async () => {
            console.log('========================================');
            console.log('    ì‹œì‘ ë²„íŠ¼ í´ë¦­ - ê¶Œí•œ ìš”ì²­ ì‹œì‘');
            console.log('========================================');

            startBtn.disabled = true;
            startBtn.textContent = 'ê¶Œí•œ ìš”ì²­ ì¤‘...';
            permissionStatus.innerHTML = '';

            try {
                // 1. ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­
                permissionStatus.innerHTML = 'ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ ì¤‘...';
                const cameraStream = await requestCameraPermission();

                if (cameraStream) {
                    permissionStatus.innerHTML = '<span class="granted">âœ“ ì¹´ë©”ë¼ ê¶Œí•œ ìŠ¹ì¸</span>';

                    // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ì„ ë¹„ë””ì˜¤ì— ì—°ê²°
                    const video = document.getElementById('video-background');
                    if (video) {
                        video.srcObject = cameraStream;
                        video.muted = true;
                        video.playsInline = true;
                        await video.play();
                        console.log('ë¹„ë””ì˜¤ ì¬ìƒ ì‹œì‘:', video.videoWidth, 'x', video.videoHeight);
                    }

                    // ì „ì—­ì— ì €ì¥
                    window.cameraStream = cameraStream;
                } else {
                    throw new Error('ì¹´ë©”ë¼ ê¶Œí•œ ê±°ë¶€ë¨');
                }

                // 2. ì„¼ì„œ ê¶Œí•œ ìš”ì²­ (iOS 13+)
                permissionStatus.innerHTML += '<br>ì„¼ì„œ ê¶Œí•œ ìš”ì²­ ì¤‘...';
                const sensorGranted = await requestSensorPermissions();

                if (sensorGranted) {
                    permissionStatus.innerHTML = '<span class="granted">âœ“ ì¹´ë©”ë¼ ê¶Œí•œ ìŠ¹ì¸</span><br>' +
                        '<span class="granted">âœ“ ì„¼ì„œ ê¶Œí•œ ìŠ¹ì¸</span>';
                } else {
                    permissionStatus.innerHTML = '<span class="granted">âœ“ ì¹´ë©”ë¼ ê¶Œí•œ ìŠ¹ì¸</span><br>' +
                        '<span class="denied">âœ— ì„¼ì„œ ê¶Œí•œ ê±°ë¶€ (ê¸°ëŠ¥ ì œí•œ)</span>';
                }

                window.sensorPermissionGranted = sensorGranted;

                // 3. ê¶Œí•œ íšë“ ì™„ë£Œ â†’ ì‹œì‘ í™”ë©´ ìˆ¨ê¸°ê³  ë¡œë”© í™”ë©´ í‘œì‹œ
                setTimeout(() => {
                    hideStartScreen();
                    showLoadingScreen();
                    updateLoadingProgress(10, 'AR ì—”ì§„ ì´ˆê¸°í™” ì¤‘...');

                    // AR ì•± ì‹œì‘ ì‹ í˜¸
                    window.permissionsGranted = true;
                    window.dispatchEvent(new CustomEvent('permissionsGranted'));
                }, 500);

            } catch (error) {
                console.error('ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨:', error);
                permissionStatus.innerHTML = `<span class="denied">âœ— ${error.message}</span>`;
                startBtn.disabled = false;
                startBtn.textContent = 'ë‹¤ì‹œ ì‹œë„';
            }
        });

        // ========================================
        // ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­
        // ========================================
        async function requestCameraPermission() {
            console.log('[Permission] ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­...');

            const constraints = {
                video: {
                    facingMode: 'environment', // í›„ë©´ ì¹´ë©”ë¼
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            };

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                console.log('[Permission] ì¹´ë©”ë¼ ê¶Œí•œ ìŠ¹ì¸ë¨');

                const track = stream.getVideoTracks()[0];
                if (track) {
                    const settings = track.getSettings();
                    console.log('[Permission] ì¹´ë©”ë¼:', settings.width, 'x', settings.height, settings.facingMode);
                }

                return stream;

            } catch (error) {
                console.error('[Permission] ì¹´ë©”ë¼ ì—ëŸ¬:', error.name, error.message);

                // í›„ë©´ ì¹´ë©”ë¼ ì‹¤íŒ¨ ì‹œ ì „ë©´ ì¹´ë©”ë¼ ì‹œë„
                if (error.name === 'OverconstrainedError') {
                    console.log('[Permission] í›„ë©´ ì¹´ë©”ë¼ ì‹¤íŒ¨, ì „ë©´ ì¹´ë©”ë¼ ì‹œë„...');
                    try {
                        const fallbackStream = await navigator.mediaDevices.getUserMedia({
                            video: { facingMode: 'user' },
                            audio: false
                        });
                        return fallbackStream;
                    } catch (e2) {
                        console.error('[Permission] ì „ë©´ ì¹´ë©”ë¼ë„ ì‹¤íŒ¨:', e2);
                    }
                }

                return null;
            }
        }

        // ========================================
        // ì„¼ì„œ ê¶Œí•œ ìš”ì²­ (iOS 13+)
        // ========================================
        async function requestSensorPermissions() {
            console.log('[Permission] ì„¼ì„œ ê¶Œí•œ ìš”ì²­...');

            let motionGranted = true;
            let orientationGranted = true;

            // DeviceMotionEvent ê¶Œí•œ (iOS 13+)
            if (typeof DeviceMotionEvent !== 'undefined' &&
                typeof DeviceMotionEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceMotionEvent.requestPermission();
                    motionGranted = (permission === 'granted');
                    console.log('[Permission] DeviceMotion:', permission);
                } catch (e) {
                    console.error('[Permission] DeviceMotion ì—ëŸ¬:', e);
                    motionGranted = false;
                }
            }

            // DeviceOrientationEvent ê¶Œí•œ (iOS 13+)
            if (typeof DeviceOrientationEvent !== 'undefined' &&
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    orientationGranted = (permission === 'granted');
                    console.log('[Permission] DeviceOrientation:', permission);
                } catch (e) {
                    console.error('[Permission] DeviceOrientation ì—ëŸ¬:', e);
                    orientationGranted = false;
                }
            }

            return motionGranted && orientationGranted;
        }

        // ========================================
        // ì¹´ë©”ë¼ ì „í™˜ í•¨ìˆ˜
        // ========================================
        window.currentFacingMode = 'environment'; // í˜„ì¬ ì¹´ë©”ë¼ ë°©í–¥ ì¶”ì 

        window.switchCamera = async function () {
            console.log('[Camera] ì¹´ë©”ë¼ ì „í™˜...');

            if (!window.cameraStream) {
                console.error('[Camera] ê¸°ì¡´ ìŠ¤íŠ¸ë¦¼ ì—†ìŒ');
                return;
            }

            // ë³€ìˆ˜ë¡œ ì¶”ì í•œ í˜„ì¬ ë°©í–¥ì„ í† ê¸€
            const newFacing = window.currentFacingMode === 'environment' ? 'user' : 'environment';

            // ê¸°ì¡´ ìŠ¤íŠ¸ë¦¼ ì •ì§€
            window.cameraStream.getTracks().forEach(t => t.stop());

            try {
                const newStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: { exact: newFacing },
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });

                window.cameraStream = newStream;
                window.currentFacingMode = newFacing;

                const video = document.getElementById('video-background');
                if (video) {
                    video.srcObject = newStream;
                    video.classList.toggle('mirror', newFacing === 'user');
                    await video.play();
                }

                console.log('[Camera] ì „í™˜ ì™„ë£Œ:', newFacing);

            } catch (error) {
                console.warn('[Camera] exact ì‹¤íŒ¨, idealë¡œ ì¬ì‹œë„:', error);
                try {
                    const fallbackStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: { ideal: newFacing },
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    });

                    window.cameraStream = fallbackStream;
                    window.currentFacingMode = newFacing;

                    const video = document.getElementById('video-background');
                    if (video) {
                        video.srcObject = fallbackStream;
                        video.classList.toggle('mirror', newFacing === 'user');
                        await video.play();
                    }

                    console.log('[Camera] ì „í™˜ ì™„ë£Œ (ideal):', newFacing);
                } catch (e2) {
                    console.error('[Camera] ì „í™˜ ì‹¤íŒ¨:', e2);
                }
            }
        };

        // ì¹´ë©”ë¼ ì „í™˜ ë²„íŠ¼ì€ main.jsì—ì„œ ì²˜ë¦¬

        // ========================================
        // ì•ˆë‚´ ì˜¤ë²„ë ˆì´ - AR ì‹œì‘ í›„ í‘œì‹œ, í„°ì¹˜ ì‹œ ì‚¬ë¼ì§
        // ========================================
        window.showInstruction = function () {
            const overlay = document.getElementById('instruction-overlay');
            if (!overlay) return;
            overlay.classList.add('visible');

            function dismiss() {
                overlay.classList.remove('visible');
                document.removeEventListener('touchstart', dismiss);
                document.removeEventListener('mousedown', dismiss);
            }
            // ì•½ê°„ ë”œë ˆì´ í›„ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (show ì§í›„ ë°”ë¡œ ì‚¬ë¼ì§€ëŠ” ê²ƒ ë°©ì§€)
            setTimeout(() => {
                document.addEventListener('touchstart', dismiss, { once: true });
                document.addEventListener('mousedown', dismiss, { once: true });
            }, 300);
        };

        // ========================================
        // ì €ì¥ìš© ë³€ìˆ˜ ë° ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
        // ========================================
        let lastSavedFile = null;
        const downloadBtn = document.getElementById('download-btn');

        function showDownloadBtn() {
            downloadBtn.classList.add('visible');
        }

        // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í´ë¦­ - ì‚¬ìš©ì ì œìŠ¤ì²˜ ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì‹¤í–‰ë¨
        downloadBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (!lastSavedFile) return;

            if (deviceInfo.isIOS && navigator.canShare && navigator.canShare({ files: [lastSavedFile] })) {
                navigator.share({ files: [lastSavedFile] })
                    .then(() => {
                        console.log('[Download] iOS - ê³µìœ  ì‹œíŠ¸ë¡œ ì €ì¥ ì™„ë£Œ');
                        // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ìˆ¨ê¹€
                        downloadBtn.classList.remove('visible');
                        lastSavedFile = null;
                    })
                    .catch((err) => {
                        if (err.name !== 'AbortError') {
                            console.log('[Download] ê³µìœ  ì‹¤íŒ¨:', err);
                        }
                    });
            } else {
                // Android ë° ê¸°íƒ€ í”Œë«í¼ì€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                const url = URL.createObjectURL(lastSavedFile);
                const a = document.createElement('a');
                a.href = url;
                a.download = lastSavedFile.name;
                a.click();
                URL.revokeObjectURL(url);
                console.log('[Download] íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
                // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ìˆ¨ê¹€
                downloadBtn.classList.remove('visible');
                lastSavedFile = null;
            }
        });

        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ í—¬í¼ í•¨ìˆ˜
        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ========================================
        // í˜ì´ì§€ visibility ë³µêµ¬ (ê³µìœ /ë‹¤ìš´ë¡œë“œ í›„ ë³µê·€ ì‹œ)
        // ========================================
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                // ì¹´ë©”ë¼ ë¹„ë””ì˜¤ ì¬ìƒ ë³µêµ¬
                const video = document.getElementById('video-background');
                if (video && video.paused && window.cameraStream) {
                    video.play().catch(e => console.warn('[Recovery] ì¹´ë©”ë¼ ì¬ìƒ ì‹¤íŒ¨:', e));
                }
                // í¬ë¡œë§ˆí‚¤ ì˜ìƒ ì¬ìƒ ë³µêµ¬
                if (window.arApp && window.arApp.hudVideo && window.arApp.hudVideo.paused) {
                    window.arApp.hudVideo.play().catch(e => console.warn('[Recovery] AR ì˜ìƒ ì¬ìƒ ì‹¤íŒ¨:', e));
                }
            }
        });

        // ========================================
        // í™”ë©´ ìº¡ì²˜ ê¸°ëŠ¥
        // ========================================
        document.getElementById('capture-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            captureScreen();
        });

        // object-fit: cover ë°©ì‹ìœ¼ë¡œ ë¹„ë””ì˜¤ë¥¼ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ëŠ” í—¬í¼
        function drawVideoCover(ctx, video, canvasWidth, canvasHeight, mirror = false) {
            const videoWidth = video.videoWidth;
            const videoHeight = video.videoHeight;
            if (videoWidth === 0 || videoHeight === 0) return;

            const videoRatio = videoWidth / videoHeight;
            const canvasRatio = canvasWidth / canvasHeight;

            let sx, sy, sWidth, sHeight;

            if (videoRatio > canvasRatio) {
                // ë¹„ë””ì˜¤ê°€ ë” ë„“ìŒ - ì¢Œìš° ì˜ë¼ëƒ„
                sHeight = videoHeight;
                sWidth = videoHeight * canvasRatio;
                sx = (videoWidth - sWidth) / 2;
                sy = 0;
            } else {
                // ë¹„ë””ì˜¤ê°€ ë” ë†’ìŒ - ìƒí•˜ ì˜ë¼ëƒ„
                sWidth = videoWidth;
                sHeight = videoWidth / canvasRatio;
                sx = 0;
                sy = (videoHeight - sHeight) / 2;
            }

            // ì „ë©´ ì¹´ë©”ë¼ ì¢Œìš° ë°˜ì „ ì²˜ë¦¬
            if (mirror) {
                ctx.save();
                ctx.scale(-1, 1);
                ctx.drawImage(video, sx, sy, sWidth, sHeight, -canvasWidth, 0, canvasWidth, canvasHeight);
                ctx.restore();
            } else {
                ctx.drawImage(video, sx, sy, sWidth, sHeight, 0, 0, canvasWidth, canvasHeight);
            }
        }

        function captureScreen() {
            const video = document.getElementById('video-background');
            const arCanvas = document.querySelector('#canvas-container canvas');
            if (!video || !arCanvas) return;

            // ì „ë©´ ì¹´ë©”ë¼ ì—¬ë¶€ í™•ì¸
            const isMirrored = window.currentFacingMode === 'user';

            // AR ìº”ë²„ìŠ¤ í¬ê¸° ê·¸ëŒ€ë¡œ ì‚¬ìš© (ê°€ì¥ ì •í™•í•¨)
            const canvas = document.createElement('canvas');
            canvas.width = arCanvas.width;
            canvas.height = arCanvas.height;
            const ctx = canvas.getContext('2d');

            // Layer 1: ë¹„ë””ì˜¤ ë°°ê²½ (object-fit: cover ë°©ì‹)
            drawVideoCover(ctx, video, canvas.width, canvas.height, isMirrored);

            // Layer 2: AR ì˜¤ë²„ë ˆì´ (ê·¸ëŒ€ë¡œ ë³µì‚¬)
            ctx.drawImage(arCanvas, 0, 0);

            // Blob ìƒì„± í›„ ì €ì¥
            canvas.toBlob((blob) => {
                const filename = 'ar-capture-' + Date.now() + '.png';
                lastSavedFile = new File([blob], filename, { type: 'image/png' });
                showDownloadBtn();
                console.log('[Capture] ìº¡ì²˜ ì™„ë£Œ - ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ìœ¼ë¡œ ì €ì¥ ê°€ëŠ¥');
            }, 'image/png');
        }

        // ========================================
        // í™”ë©´ ë…¹í™” ê¸°ëŠ¥
        // ========================================
        let mediaRecorder = null;
        let recordedChunks = [];
        let recordingStream = null;
        let isRecording = false;  // ë…¹í™” ìƒíƒœ ì¶”ì 

        const recordBtn = document.getElementById('record-btn');
        if (!recordBtn) {
            console.error('[Record] ë…¹í™” ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        } else {
            console.log('[Record] ë…¹í™” ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡');
            recordBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                console.log('[Record] ë…¹í™” ë²„íŠ¼ í´ë¦­ë¨, í˜„ì¬ ìƒíƒœ:', isRecording);

                if (isRecording) {
                    console.log('[Record] ë…¹í™” ì¤‘ì§€ í˜¸ì¶œ');
                    stopRecording();
                } else {
                    console.log('[Record] ë…¹í™” ì‹œì‘ í˜¸ì¶œ');
                    startRecording();
                }
            });
        }

        // ë¸Œë¼ìš°ì €ê°€ ì§€ì›í•˜ëŠ” ìµœì  ë…¹í™” í¬ë§· ê°ì§€
        function getRecordingFormat() {
            console.log('[Record] === ì§€ì› í¬ë§· ê°ì§€ ì‹œì‘ ===');
            const types = [
                // iOS í˜¸í™˜ì„±ì„ ìœ„í•´ MP4 ìš°ì„ 
                { mimeType: 'video/mp4', ext: 'mp4' },
                { mimeType: 'video/mp4;codecs=avc1', ext: 'mp4' },
                { mimeType: 'video/mp4;codecs=h264', ext: 'mp4' },
                // WebM í´ë°±
                { mimeType: 'video/webm;codecs=vp9', ext: 'webm' },
                { mimeType: 'video/webm;codecs=vp8', ext: 'webm' },
                { mimeType: 'video/webm', ext: 'webm' },
            ];

            console.log('[Record] í…ŒìŠ¤íŠ¸í•  í¬ë§·:', types.length, 'ê°œ');

            for (const t of types) {
                const supported = MediaRecorder.isTypeSupported(t.mimeType);
                console.log('[Record] í¬ë§· í…ŒìŠ¤íŠ¸:', t.mimeType, 'â†’', supported ? 'âœ“ ì§€ì›' : 'âœ— ë¯¸ì§€ì›');
                if (supported) {
                    console.log('[Record] âœ“ ì„ íƒëœ í¬ë§·:', t.mimeType);
                    return t;
                }
            }

            console.warn('[Record] âš  ì§€ì›ë˜ëŠ” í¬ë§· ì—†ìŒ! ê¸°ë³¸ê°’ ì‚¬ìš©');
            return { mimeType: '', ext: 'mp4' }; // ë¹ˆ mimeType = ë¸Œë¼ìš°ì € ê¸°ë³¸ê°’, í™•ì¥ìëŠ” mp4
        }

        let recordingFormat = null;
        let recordingAnimId = null;

        function startRecording() {
            console.log('[Record] === startRecording í•¨ìˆ˜ ì‹œì‘ ===');
            const video = document.getElementById('video-background');
            const arCanvas = document.querySelector('#canvas-container canvas');

            if (!video) {
                console.error('[Record] video ì—˜ë¦¬ë¨¼íŠ¸ ì—†ìŒ!');
                return;
            }
            if (!arCanvas) {
                console.error('[Record] AR ìº”ë²„ìŠ¤ ì—†ìŒ!');
                return;
            }

            console.log('[Record] ë¹„ë””ì˜¤/ìº”ë²„ìŠ¤ í™•ì¸ ì™„ë£Œ');

            try {
                recordingFormat = getRecordingFormat();
                console.log('[Record] ë…¹í™” í¬ë§·:', recordingFormat);

                // ì „ë©´ ì¹´ë©”ë¼ ì—¬ë¶€ (ë…¹í™” ì‹œì‘ ì‹œì  ê¸°ì¤€)
                const isMirrored = window.currentFacingMode === 'user';
                console.log('[Record] ë¯¸ëŸ¬ë§ ëª¨ë“œ:', isMirrored);

                // === í™”ì§ˆ ê°œì„ : ê³ í•´ìƒë„ ìº”ë²„ìŠ¤ ì‚¬ìš© ===
                const pixelRatio = window.devicePixelRatio || 1;
                const canvasWidth = window.innerWidth * pixelRatio;
                const canvasHeight = window.innerHeight * pixelRatio;

                const compositeCanvas = document.createElement('canvas');
                compositeCanvas.width = canvasWidth;
                compositeCanvas.height = canvasHeight;
                const ctx = compositeCanvas.getContext('2d', {
                    alpha: false,  // ì•ŒíŒŒ ì±„ë„ ë¶ˆí•„ìš” (ì„±ëŠ¥ í–¥ìƒ)
                    desynchronized: true  // ì„±ëŠ¥ ìµœì í™”
                });
                console.log('[Record] í•©ì„± ìº”ë²„ìŠ¤ ìƒì„±:', compositeCanvas.width, 'x', compositeCanvas.height, '(í”½ì…€ë¹„ìœ¨:', pixelRatio + ')');

                // í”„ë ˆì„ í•©ì„± ë£¨í”„
                function drawFrame() {
                    if (!isRecording) return;
                    drawVideoCover(ctx, video, compositeCanvas.width, compositeCanvas.height, isMirrored);
                    ctx.drawImage(arCanvas, 0, 0, arCanvas.width, arCanvas.height, 0, 0, compositeCanvas.width, compositeCanvas.height);
                    recordingAnimId = requestAnimationFrame(drawFrame);
                }

                // ìº”ë²„ìŠ¤ì—ì„œ ìŠ¤íŠ¸ë¦¼ ìƒì„± (60fps)
                recordingStream = compositeCanvas.captureStream(60);
                recordedChunks = [];
                console.log('[Record] ìŠ¤íŠ¸ë¦¼ ìƒì„± ì™„ë£Œ (60fps)');

                // === í™”ì§ˆ ê°œì„ : ê³ ë¹„íŠ¸ë ˆì´íŠ¸ ì„¤ì • ===
                const options = recordingFormat.mimeType
                    ? {
                        mimeType: recordingFormat.mimeType,
                        videoBitsPerSecond: 8000000  // 8Mbps (ê³ í™”ì§ˆ)
                    }
                    : {
                        videoBitsPerSecond: 8000000  // 8Mbps (ê³ í™”ì§ˆ)
                    };
                console.log('[Record] MediaRecorder ì˜µì…˜:', options);
                mediaRecorder = new MediaRecorder(recordingStream, options);
                console.log('[Record] MediaRecorder ìƒì„± ì™„ë£Œ');

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        recordedChunks.push(e.data);
                        console.log('[Record] ë°ì´í„° ìˆ˜ì‹ :', e.data.size, 'bytes, ì´:', recordedChunks.length, 'ì²­í¬');
                    }
                };

                mediaRecorder.onstop = () => {
                    console.log('[Record] === MediaRecorder ì¤‘ì§€ë¨ ===');
                    isRecording = false;
                    cancelAnimationFrame(recordingAnimId);
                    recordBtn.classList.remove('recording');

                    console.log('[Record] ì´ ì²­í¬ ìˆ˜:', recordedChunks.length);

                    const blobType = recordingFormat.ext === 'mp4' ? 'video/mp4' : 'video/webm';
                    const blob = new Blob(recordedChunks, { type: blobType });
                    const filename = 'ar-recording-' + Date.now() + '.' + recordingFormat.ext;

                    console.log('[Record] Blob í¬ê¸°:', blob.size, 'bytes');

                    lastSavedFile = new File([blob], filename, { type: blobType });
                    showDownloadBtn();
                    console.log('[Record] ë…¹í™” ì™„ë£Œ - ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ìœ¼ë¡œ ì €ì¥ ê°€ëŠ¥');

                    recordedChunks = [];
                    mediaRecorder = null;
                };

                mediaRecorder.onerror = (e) => {
                    console.error('[Record] === MediaRecorder ì—ëŸ¬ ë°œìƒ! ===');
                    console.error('[Record] ì—ëŸ¬ íƒ€ì…:', e.error ? e.error.name : 'Unknown');
                    console.error('[Record] ì—ëŸ¬ ë©”ì‹œì§€:', e.error ? e.error.message : 'No message');
                    console.error('[Record] ì „ì²´ ì—ëŸ¬:', e);
                    isRecording = false;
                    if (recordBtn) recordBtn.classList.remove('recording');
                };

                console.log('[Record] MediaRecorder ì‹œì‘ ì§ì „, isRecording:', isRecording);

                // MediaRecorder.start()ë¥¼ try-catchë¡œ ê°ì‹¸ê¸°
                try {
                    // timeslice íŒŒë¼ë¯¸í„° ì¶”ê°€ (100msë§ˆë‹¤ ë°ì´í„° ìˆ˜ì§‘)
                    mediaRecorder.start(100);
                    isRecording = true;
                    recordBtn.classList.add('recording');
                    drawFrame();
                    console.log('[Record] === ë…¹í™” ì‹œì‘ë¨! ===');
                } catch (startError) {
                    console.error('[Record] mediaRecorder.start() ì‹¤íŒ¨:', startError);
                    console.error('[Record] ì—ëŸ¬ ì´ë¦„:', startError.name);
                    console.error('[Record] ì—ëŸ¬ ë©”ì‹œì§€:', startError.message);
                    isRecording = false;
                    if (recordBtn) recordBtn.classList.remove('recording');
                    throw startError;
                }
            } catch (error) {
                console.error('[Record] ë…¹í™” ì‹œì‘ ì‹¤íŒ¨:', error);
                isRecording = false;
                if (recordBtn) recordBtn.classList.remove('recording');
            }
        }

        function stopRecording() {
            console.log('[Record] ë…¹í™” ì •ì§€ ìš”ì²­');
            isRecording = false;
            if (mediaRecorder) {
                try {
                    if (mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                    }
                } catch (e) {
                    console.warn('[Record] ë…¹í™” ì •ì§€ ì˜¤ë¥˜:', e);
                }
            }
            cancelAnimationFrame(recordingAnimId);
            recordBtn.classList.remove('recording');
        }

        // ========================================
        // ì˜ìƒ ì„ íƒ ë²„íŠ¼ ì´ë²¤íŠ¸
        // ========================================
        document.querySelectorAll('.video-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();

                // í™œì„± ë²„íŠ¼ ì—…ë°ì´íŠ¸
                document.querySelectorAll('.video-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // ì˜ìƒ ë³€ê²½ (main.jsì˜ í•¨ìˆ˜ í˜¸ì¶œ)
                const videoSrc = btn.dataset.video;
                if (window.changeARVideo) {
                    window.changeARVideo(videoSrc);
                }
            });
        });
    </script>
</body>

</html>